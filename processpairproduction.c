/*****************************************************************************/
/*                                                                           */
/* serpent 2 (beta-version) : processpairproduction.c                        */
/*                                                                           */
/* Created:       2014/11/21 (TKa)                                           */
/* Last modified: 2017/03/08 (TKa)                                           */
/* Version:       2.1.29                                                     */
/*                                                                           */
/* Description: Processes pair production data                               */
/*                                                                           */
/* Comments:                                                                 */
/*                                                                           */
/*****************************************************************************/

#include "header.h"
#include "locations.h"

#define FUNCTION_NAME "ProcessPairProduction:"


/*****************************************************************************/

void ProcessPairProduction(long loc0, long nuc) {
  long i, ptr, Z;
  double a, a2, fc;
  const double Emax = 1.0e6;

  /* Sampling coefficients applicable between 2 and 200 MeV.
   * Recalculated due to the typo mentioned below. (TKa 9.2.2017 / 2.1.29) */
  const double ppmaxdxsfitc200MeV[100][5] = {
    {16.349, 620.63, -945.73, 98.582, 372.28},
    {15.961, 593.64, -892.12, 94.995, 352.74},
    {15.710, 575.84, -858.29, 92.722, 339.55},
    {15.519, 562.13, -832.88, 91.023, 329.19},
    {15.364, 550.77, -812.23, 89.650, 320.46},
    {15.232, 540.97, -794.66, 88.491, 312.82},
    {15.117, 532.27, -779.25, 87.482, 305.96},
    {15.014, 524.41, -765.45, 86.587, 299.71},
    {14.920, 517.20, -752.90, 85.781, 293.93},
    {14.834, 510.52, -741.36, 85.045, 288.55},
    {14.754, 504.28, -730.64, 84.369, 283.49},
    {14.680, 498.40, -720.62, 83.742, 278.71},
    {14.609, 492.84, -711.17, 83.157, 274.18},
    {14.542, 487.56, -702.23, 82.608, 269.86},
    {14.479, 482.51, -693.73, 82.091, 265.73},
    {14.418, 477.67, -685.61, 81.603, 261.77},
    {14.359, 473.03, -677.83, 81.139, 257.96},
    {14.303, 468.55, -670.35, 80.699, 254.30},
    {14.248, 464.22, -663.15, 80.278, 250.75},
    {14.195, 460.02, -656.18, 79.876, 247.33},
    {14.143, 455.96, -649.44, 79.491, 244.01},
    {14.093, 452.01, -642.89, 79.121, 240.79},
    {14.044, 448.16, -636.52, 78.765, 237.66},
    {13.996, 444.40, -630.32, 78.422, 234.62},
    {13.948, 440.74, -624.26, 78.091, 231.66},
    {13.902, 437.15, -618.34, 77.771, 228.76},
    {13.856, 433.64, -612.54, 77.461, 225.94},
    {13.811, 430.20, -606.86, 77.161, 223.18},
    {13.767, 426.82, -601.27, 76.869, 220.48},
    {13.723, 423.50, -595.78, 76.586, 217.84},
    {13.680, 420.24, -590.38, 76.309, 215.25},
    {13.637, 417.02, -585.05, 76.040, 212.70},
    {13.595, 413.85, -579.78, 75.777, 210.20},
    {13.553, 410.73, -574.59, 75.521, 207.74},
    {13.511, 407.63, -569.43, 75.268, 205.32},
    {13.469, 403.87, -563.43, 74.934, 202.50},
    {13.427, 400.81, -558.34, 74.687, 200.13},
    {13.385, 397.30, -552.65, 74.382, 197.49},
    {13.342, 393.73, -546.89, 74.066, 194.84},
    {13.299, 390.09, -541.05, 73.742, 192.17},
    {13.254, 386.24, -534.91, 73.381, 189.40},
    {13.207, 382.22, -528.55, 72.992, 186.56},
    {13.161, 378.21, -522.21, 72.605, 183.74},
    {13.115, 374.22, -515.89, 72.220, 180.94},
    {13.070, 370.25, -509.59, 71.837, 178.16},
    {13.024, 366.30, -503.30, 71.454, 175.40},
    {12.981, 362.59, -497.33, 71.111, 172.78},
    {12.938, 358.87, -491.34, 70.765, 170.15},
    {12.895, 355.12, -485.30, 70.413, 167.52},
    {12.851, 351.38, -479.27, 70.060, 164.91},
    {12.808, 347.61, -473.18, 69.701, 162.28},
    {12.765, 343.81, -467.07, 69.338, 159.65},
    {12.721, 340.01, -460.93, 68.970, 157.02},
    {12.677, 336.18, -454.76, 68.598, 154.39},
    {12.633, 332.35, -448.56, 68.221, 151.76},
    {12.590, 328.48, -442.33, 67.839, 149.12},
    {12.546, 324.63, -436.10, 67.455, 146.50},
    {12.502, 320.76, -429.84, 67.066, 143.86},
    {12.457, 316.87, -423.56, 66.673, 141.23},
    {12.413, 312.99, -417.28, 66.277, 138.60},
    {12.369, 309.10, -411.00, 65.879, 135.97},
    {12.325, 305.21, -404.70, 65.476, 133.34},
    {12.281, 301.31, -398.39, 65.070, 130.71},
    {12.237, 297.41, -392.08, 64.659, 128.08},
    {12.192, 293.50, -385.76, 64.245, 125.46},
    {12.148, 289.58, -379.44, 63.827, 122.83},
    {12.104, 285.68, -373.13, 63.407, 120.21},
    {12.060, 281.85, -366.92, 62.998, 117.62},
    {12.017, 278.07, -360.77, 62.593, 115.06},
    {11.974, 274.27, -354.61, 62.182, 112.49},
    {11.931, 270.48, -348.46, 61.768, 109.93},
    {11.888, 266.69, -342.33, 61.352, 107.36},
    {11.844, 262.91, -336.22, 60.933, 104.80},
    {11.801, 259.14, -330.13, 60.512, 102.25},
    {11.758, 255.38, -324.07, 60.088, 99.706},
    {11.715, 251.63, -318.04, 59.663, 97.165},
    {11.672, 247.90, -312.04, 59.235, 94.633},
    {11.629, 244.18, -306.08, 58.806, 92.108},
    {11.586, 240.48, -300.16, 58.375, 89.591},
    {11.543, 236.80, -294.28, 57.942, 87.085},
    {11.500, 233.14, -288.46, 57.509, 84.588},
    {11.457, 229.50, -282.68, 57.073, 82.102},
    {11.415, 225.89, -276.95, 56.638, 79.629},
    {11.371, 222.11, -271.09, 56.168, 77.089},
    {11.329, 218.73, -265.68, 55.764, 74.721},
    {11.287, 215.20, -260.15, 55.327, 72.289},
    {11.244, 211.69, -254.68, 54.890, 69.871},
    {11.203, 208.29, -249.36, 54.469, 67.494},
    {11.165, 205.08, -244.29, 54.083, 65.188},
    {11.126, 201.90, -239.29, 53.697, 62.892},
    {11.088, 198.74, -234.36, 53.311, 60.610},
    {11.050, 195.58, -229.47, 52.919, 58.330},
    {11.012, 192.49, -224.69, 52.534, 56.077},
    {10.974, 189.43, -219.99, 52.149, 53.838},
    {10.936, 186.42, -215.39, 51.768, 51.620},
    {10.899, 183.40, -210.83, 51.380, 49.404},
    {10.861, 180.44, -206.37, 50.995, 47.209},
    {10.824, 177.52, -202.01, 50.614, 45.035},
    {10.787, 174.61, -197.72, 50.230, 42.870},
    {10.753, 172.99, -194.50, 50.060, 41.417}
  };

  /* Sampling coefficients applicable between 200 MeV and 1 TeV. However,
   * ultrarelativistic effects were not taken into account in the calculations.
   * The physical upper limit for applying these is ~100 GeV. */
  const double ppmaxdxsfitc1TeV[100][5] = {
    {18.8136, -68.2745, 192.602, -6.26932, 32.9032},
    {17.7675, -43.3072, 120.057, -5.43108, 31.2612},
    {17.1887, -30.4102, 83.2019, -4.94565, 30.2107},
    {16.8942, -29.6152, 82.8558, -4.85606, 29.6196},
    {16.7064, -32.8491, 95.2440, -4.92825, 29.3835},
    {16.5863, -38.4791, 114.544, -5.09998, 29.3266},
    {16.5080, -45.2390, 136.585, -5.32283, 29.3466},
    {16.4418, -51.5424, 156.906, -5.54124, 29.4080},
    {16.4138, -59.2372, 180.325, -5.81068, 29.4593},
    {16.3770, -65.5165, 199.372, -6.03861, 29.5145},
    {16.3463, -73.0106, 223.845, -6.34125, 29.8736},
    {16.3293, -79.4563, 242.779, -6.58523, 29.9511},
    {16.3112, -85.0998, 258.837, -6.79974, 29.9750},
    {16.3430, -93.1254, 280.312, -7.08928, 29.9001},
    {16.2437, -92.9396, 280.452, -7.11410, 29.9703},
    {16.3179, -102.675, 305.808, -7.45691, 29.8180},
    {16.2159, -101.409, 302.693, -7.43615, 29.8370},
    {16.2088, -105.270, 311.945, -7.57740, 29.6829},
    {16.1815, -107.469, 316.484, -7.65825, 29.5032},
    {16.1280, -108.196, 317.686, -7.69546, 29.4054},
    {16.0750, -108.602, 317.803, -7.71721, 29.2770},
    {16.0205, -108.863, 317.652, -7.73560, 29.1671},
    {15.9731, -109.328, 317.947, -7.75970, 29.0481},
    {15.9098, -108.708, 315.447, -7.74382, 28.9318},
    {15.8558, -108.570, 314.368, -7.74600, 28.8323},
    {15.7872, -107.626, 311.563, -7.72259, 28.7809},
    {15.7298, -107.136, 309.720, -7.71230, 28.7004},
    {15.6988, -107.903, 310.660, -7.74177, 28.5570},
    {15.6441, -107.490, 309.062, -7.73477, 28.4843},
    {15.5901, -107.027, 307.294, -7.72505, 28.4073},
    {15.5145, -105.318, 302.638, -7.67219, 28.3744},
    {15.4494, -104.169, 299.323, -7.63881, 28.3283},
    {15.4326, -105.529, 301.778, -7.69150, 28.1932},
    {15.3849, -105.251, 300.444, -7.68757, 28.1124},
    {15.2914, -102.339, 292.910, -7.58868, 28.1036},
    {15.2272, -101.127, 289.506, -7.55264, 28.0689},
    {15.1843, -100.898, 288.184, -7.54736, 27.9714},
    {15.1172, -99.4487, 284.223, -7.50212, 27.9443},
    {15.0764, -99.2879, 283.067, -7.49909, 27.8462},
    {15.0395, -99.3704, 282.557, -7.50609, 27.7526},
    {15.0038, -99.5507, 282.381, -7.51926, 27.6768},
    {14.9196, -97.0468, 275.936, -7.43293, 27.6714},
    {14.8821, -97.0274, 275.219, -7.43603, 27.5846},
    {14.8080, -95.1783, 270.513, -7.37716, 27.5954},
    {14.7707, -95.1222, 269.686, -7.37809, 27.5049},
    {14.7217, -94.5021, 267.688, -7.36073, 27.4537},
    {14.6739, -93.9356, 265.824, -7.34529, 27.4018},
    {14.6376, -93.9265, 265.193, -7.34910, 27.3230},
    {14.5664, -92.2031, 260.872, -7.29436, 27.3418},
    {14.5412, -92.6961, 261.302, -7.31461, 27.2305},
    {14.5121, -93.1208, 261.753, -7.33721, 27.1557},
    {14.4641, -92.4993, 259.834, -7.32005, 27.1159},
    {14.4137, -91.6770, 257.362, -7.29394, 27.0704},
    {14.3569, -89.8375, 251.579, -7.21793, 26.9395},
    {14.2767, -87.9890, 247.672, -7.16201, 27.0363},
    {14.2399, -87.8480, 246.724, -7.16017, 26.9615},
    {13.9896, -68.5606, 187.363, -6.26019, 25.7032},
    {13.9516, -68.6863, 187.274, -6.26709, 25.6391},
    {13.9114, -68.6618, 187.267, -6.27459, 25.6408},
    {13.8710, -68.5972, 187.097, -6.27993, 25.6353},
    {13.8292, -68.5198, 186.932, -6.28669, 25.6397},
    {13.7727, -67.1145, 182.948, -6.23049, 25.5839},
    {13.7387, -67.4164, 183.780, -6.25081, 25.5840},
    {13.7004, -67.4757, 183.968, -6.26196, 25.5852},
    {13.6603, -67.3711, 183.691, -6.26560, 25.5807},
    {13.6170, -67.0009, 182.656, -6.25689, 25.5658},
    {13.5374, -64.0987, 174.897, -6.13885, 25.5260},
    {13.5026, -64.0769, 174.927, -6.14560, 25.5304},
    {13.4756, -65.0081, 177.096, -6.19096, 25.4986},
    {13.4465, -65.6337, 178.851, -6.22693, 25.5139},
    {13.4102, -65.7813, 179.295, -6.24247, 25.5208},
    {13.3693, -65.5297, 178.560, -6.23886, 25.5069},
    {13.3297, -65.4003, 178.268, -6.24175, 25.5099},
    {13.2496, -62.3764, 170.168, -6.11502, 25.4645},
    {13.2411, -64.3051, 175.150, -6.20624, 25.4630},
    {13.2033, -64.2923, 175.197, -6.21471, 25.4721},
    {13.1666, -64.3467, 175.381, -6.22601, 25.4770},
    {13.1269, -64.1229, 174.699, -6.22324, 25.4611},
    {13.0757, -63.1392, 172.074, -6.18727, 25.4476},
    {13.0409, -63.1631, 172.057, -6.19430, 25.4317},
    {12.9969, -62.7310, 170.983, -6.18473, 25.4384},
    {12.9637, -62.8896, 171.419, -6.19895, 25.4374},
    {12.8975, -60.8635, 166.133, -6.11679, 25.4281},
    {12.8834, -62.2775, 169.681, -6.18564, 25.4110},
    {12.8396, -61.8305, 168.570, -6.17517, 25.4181},
    {12.8055, -61.8440, 168.524, -6.18158, 25.4016},
    {12.7699, -61.8992, 168.770, -6.19345, 25.4153},
    {12.7339, -61.8906, 168.741, -6.20145, 25.4141},
    {12.6962, -61.7460, 168.418, -6.20334, 25.4191},
    {12.6587, -61.6095, 168.075, -6.20531, 25.4189},
    {12.6216, -61.5030, 167.854, -6.20919, 25.4252},
    {12.5833, -61.2503, 167.138, -6.20473, 25.4137},
    {12.5456, -61.0541, 166.624, -6.20357, 25.4107},
    {12.4952, -59.9512, 163.615, -6.15894, 25.3848},
    {12.4648, -60.1828, 164.235, -6.17662, 25.3833},
    {12.4282, -60.0455, 163.891, -6.17828, 25.3829},
    {12.3918, -59.9047, 163.538, -6.17972, 25.3822},
    {12.3554, -59.7624, 163.175, -6.18100, 25.3807},
    {12.3191, -59.6157, 162.807, -6.18210, 25.3800},
    {12.2830, -59.4675, 162.435, -6.18308, 25.3791}
  };

  /* Check pointers */
  CheckPointer(FUNCTION_NAME, "(loc0)", DATA_ARRAY, loc0);
  CheckPointer(FUNCTION_NAME, "(nuc)", DATA_ARRAY, nuc);

  /* Check energy limit */
  if (RDB[DATA_PHOTON_EMAX] > Emax)
    Die(FUNCTION_NAME, "Maximum photon energy (%f MeV) above the pair "
                       "production maximum (%f MeV)", RDB[DATA_PHOTON_EMAX],
                       Emax);

  Z = (long)RDB[nuc + NUCLIDE_Z];

  /* Calculate constants */
  a = (double)Z*FS_CONST;
  a2 = a*a;
  fc = a2*(1.0/(1.0 + a2) + 0.202059 - a2*(0.03693 - a2*(0.00835
      - a2*(0.00201 - a2*(0.00049 - a2*(0.00012 - a2*0.00003))))));

  /* Store fit coefficients for the maximum differential xs (2 - 200 MeV)*/
  ptr = ReallocMem(DATA_ARRAY, 5);
  WDB[loc0 + PHOTON_DIST_PP_MDXSFC1] = (double)ptr;

  for (i = 0; i < 5; i++)
   WDB[ptr++] = ppmaxdxsfitc200MeV[Z - 1][i];

  /* Coefficients for the maximum differential xs (200 MeV - 1 TeV) */
  ptr = ReallocMem(DATA_ARRAY, 5);
  WDB[loc0 + PHOTON_DIST_PP_MDXSFC2] = (double)ptr;

  for (i = 0; i < 5; i++)
   WDB[ptr++] = ppmaxdxsfitc1TeV[Z - 1][i];

  /* Store coefficient FC */
  WDB[loc0 + PHOTON_DIST_PP_FC] = -4.0*(log((double)Z)/3.0 + fc);

  /* Store coefficient array F0 */
  ptr = ReallocMem(DATA_ARRAY, 4);
  WDB[loc0 + PHOTON_DIST_PP_F0] = (double)ptr;

  /* The first coefficient was corrected from -0.1774 to -1.774. The typo is
   * also present in Toni's thesis, Eq.(3.136), and in PENELOPE manual.
   * (TKa 9.2.2017 / 2.1.29) */
  WDB[ptr] = -1.774 - 12.10*a + 11.18*a2;
  WDB[ptr + 1] = 8.523 + 73.26*a - 44.41*a2;
  WDB[ptr + 2] = -13.52 - 121.1*a + 96.41*a2;
  WDB[ptr + 3] = 8.946 + 62.05*a - 63.41*a2;

  /* Store coefficient G0 */
  WDB[loc0 + PHOTON_DIST_PP_G0] = 136.0/pow((double)Z, 1.0/3.0);

}

/*****************************************************************************/
